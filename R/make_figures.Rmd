This script is to make figures showing the results.

```{r}
library(tidyverse)
library(ggplot2)
library(ggtree)

# Analysis-specific parameters
data_dir <- "nextflow/results/boston_confa_2023-04-21T13:14:43.502924-07:00"
outbreak_annotation <- "CONF_A"
focal_region_annotation <- "Massachusetts"
focal_outbreak_samples <- c(
    "MT520428.1",
    "MT520429.1",
    "MT520386.1",
    "MT520192.1",
    "MT520178.1",
    "MT520441.1",
    "MT520375.1",
    "MT520325.1",
    "MT520446.1",
    "MT520509.1",
    "MT520408.1",
    "MT520316.1",
    "MT520517.1",
    "MT520503.1",
    "MT520459.1",
    "MT520287.1",
    "MT520191.1",
    "MT520470.1",
    "MT520341.1",
    "MT520327.1",
    "MT520547.1",
    "MT520472.1",
    "MT520396.1",
    "MT520314.1",
    "MT520388.1",
    "MT520320.1",
    "MT520282.1",
    "MT520310.1")

# data_dir <- "nextflow/results/urmc_klebsiella_2023-04-21T10:26:45.975059-07:00"
# outbreak_annotation <- "URMC"
# focal_region_annotation <- "URMC"
# focal_outbreak_samples <- c(
#     "GCF_003952105.1_ASM395210v1_genomic.fna",
#     "GCF_003952055.1_ASM395205v1_genomic.fna",
#     "GCF_003951125.1_ASM395112v1_genomic.fna",
#     "GCF_003950635.1_ASM395063v1_genomic.fna",
#     "GCF_003951615.1_ASM395161v1_genomic.fna",
#     "GCF_003951535.1_ASM395153v1_genomic.fna",
#     "GCF_003950575.1_ASM395057v1_genomic.fna",
#     "GCF_003952905.1_ASM395290v1_genomic.fna",
#     "GCF_003950595.1_ASM395059v1_genomic.fna",
#     "GCF_003951195.1_ASM395119v1_genomic.fna",
#     "GCF_003951575.1_ASM395157v1_genomic.fna",
#     "GCF_003951635.1_ASM395163v1_genomic.fna",
#     "GCF_003951115.1_ASM395111v1_genomic.fna",
#     "GCF_003952145.1_ASM395214v1_genomic.fna",
#     "GCF_003952035.1_ASM395203v1_genomic.fna")  # These are the CICU outbreak isolates

# Load collated results
results_per_sample <- read.delim(paste0(data_dir, "/collated_results_per_sample.txt"), sep = " ") %>%
    mutate(method = factor(method, levels = c("hivtrace", "clustertracker", "mugration")))
results_per_introduction <- read.delim(paste0(data_dir, "/collated_results_per_introduction.txt"), sep = " ") %>%
    mutate(method = factor(method, levels = c("hivtrace", "clustertracker", "mugration")))
```

Plot number of clusters by method
```{r}
outbreak_clusters_by_method <- results_per_sample %>%
    filter(sample %in% focal_outbreak_samples) %>%
    group_by(method) %>%
    summarise(n_samples = n(), n_clusters = length(unique(introduction_node)))

ggplot(data = outbreak_clusters_by_method) +
    geom_col(aes(x = method, y = n_clusters)) + 
    theme_bw() + 
    labs(x = element_blank(), y = "# clusters with focal region samples")
ggsave(file = paste0(data_dir, "/clusters_by_method.png"), width = 3, height = 4)
```

Plot size of sampled outbreak
```{r}
focal_outbreak_introductions <- results_per_introduction %>%
    filter(label %in% focal_outbreak_samples) %>%
    dplyr::select(introduction_node, method) %>%
    unique()

outbreak_spread_by_method <- results_per_introduction %>%
    right_join(focal_outbreak_introductions) %>%  # only consider samples in focal outbreak cluster
    group_by(method) %>%
    summarize(
        n_introduction_nodes = length(unique(introduction_node)),
        `Context` = sum(!(tip_location %in% c(outbreak_annotation, focal_region_annotation))),
        `Outbreak` = sum(sum(label %in% focal_outbreak_samples)),
        `Focal region` = sum(tip_location == focal_region_annotation & !(label %in% focal_outbreak_samples))) %>%
    pivot_longer(cols = c(`Context`, `Outbreak`, `Focal region`), names_to = "Sample type")

ggplot(data = outbreak_spread_by_method) +
    geom_bar(aes(x = method, y = value, fill = `Sample type`), position = "stack", stat = "identity") +
    theme_bw() +
    labs(x = element_blank(), y = "# samples in the focal outbreak cluster(s)")
ggsave(file = paste0(data_dir, "/outbreak_size_by_method.png"), width = 4, height = 4)
```

Bits and bobs, leftovers
```{r}
# ggtree(mugration_treeio) + 
#     geom_label(aes(label = division)) +
#     geom_tiplab()
# ggsave("~/Downloads/tree.png", width = 20, height = 20)   
```